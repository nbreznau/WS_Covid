---
title: 'Institutionalized Inequality and Risk Perceptions: Government Intervention
  and Social Welfare during the Novel Coronavirus Pandemic'
output:
  html_document:
    df_print: paged
---

This is a follow up study of 

Breznau, Nate. 2020. “The Welfare State and Risk Perceptions: The Novel Coronavirus Pandemic and Public Concern in 70 Countries.” *European Societies*.

The following files are necessary to run this code
**ACLED COVID-19 Disorder Tracker**
*coronavirus_Aug01.xlsx*: [link](https://osf.io/usq5b/) 

Fetzer, T., Witte, M., Hensel, L., Jachimowicz, J.M., Haushofer, J., Ivchenko, A., Caria, C., Reutskaja, E., Roth, C., Fiorin, F., Gomez, M., Kraft-Todd, G., Goetz, F., & Yoeli, E.. Global Behaviors and Perceptions in the COVID-19 Pandemic. https://doi.org/10.31234/osf.io/3kfmh

**Blavatnik School of Gov. Covid Stringency Index**
*covid-stringency-index.csv*: [link](https://ourworldindata.org/grapher/covid-stringency-index
WID_Data_14082020-111941.xlsx) Dowloaded via ['Our World in Data'](https://wid.world/data/)

**ISSP RoG 2016**
Available from GESIS 
*ZA6900_v2-0-0.dta*                     

**Solt Gini Data**
*swiid9_0.rda*
Solt, Frederick. 2020. "Measuring Income Inequality Across Countries and Over Time: The Standardized World Income Inequality Database." Social Science Quarterly doi: 10.1111/ssqu.12795


Note's for Hung:
1 - I changed the behavior variables to standardized instead of divided by 20. This divided by 20 was a good idea, but it makes the scale from 0 to 5 which is not comparable to 1 to 5 (in the ISSP). So rather than complicate things, standardization is better. I also did standardization for the containment health index, all 'scales' should be standardized IMO. 

2 - please fix the code in the chunk that makes the descriptives so that it includes only "Mean", "SD", "Min" and "Max" and only for the variables we use in the analysis. So ignore the individual-level variables in this table and drop the number of cases column as we do not run multilevel models so we do not actually use these cases in our analysis. But make sure to include the aggregate variables (public preferences and public behavior scales - there are three of them now one pooled, one for intermediate phase and one for reaction phase).

3 - We should not predict behaviors from the Outbreak Stage (1st Stage) with the chi in the Public Reaction Phase (2nd Stage). Therefore, I broke the dependent variable into two parts, one for the main analysis (betrack scores after March 24th) and one for the Intermediate Phase (the  sensitivity analysis, with betrack scores form before March 27th). I did not use exactly April 1st to 7th to try and increase the case numbers without going too far out of the realistic causal range of behaviors.

4 - I added current CHI (health measures) into the Public Reaction Stage models because current government intervention should be a primary cause of public behaviors. This created the expected effect, that although the public tends to follow the government's measures (r2 = .32) the discrepancy gap has a negative impact making them slightly less likely to follow if the government has intervened much more than they preferred, or more likely to be cautious if the government was less likely. I created a figure that demonstrates this Fig_new.png, I have added it to the text.


### Setup


```{r setup}
wdir <- function(x){
  paste(getwd(),x, sep = "/")
}

# need pacman package installed to run this
# install.packages("pacman")
pacman::p_load("dplyr","countrycode","car","ggplot2","jtools","sjPlot","sjmisc","sjlabelled","tidyverse","psych","lavaan","kableExtra","ggrepel","stringi","margins","readxl","semPlot","htmlTable", "countrycode","haven","semTable","ragg")

```

### Load Data

```{r load_prep, message = F, warning = F}

# COVID-19 Survey

betrack <- read_dta(wdir("data/GlobalBehaviorsPerceptions_Data_May21_2020.dta")) 

# government response
gov_resp <- read.csv(file = wdir("data/OxCGRT_latest.csv"), header = T)


# ISSP RoG
issp16 <- read_dta(wdir("data/ZA6900_v2-0-0.dta"))

# Solt Gini
swiid <- load(wdir("data/swiid9_0.rda"))

# Death per million

covid <- read.csv(file = wdir("data/owid-covid-data.csv"), header = T)

## GDP per capita (2019)
gdp <- read.csv(file = wdir("data/GDP per capita WB.csv"), header = T,skip = 4)

## Social Spending 

socp <- read_xlsx(wdir("data/54614.xlsx"), skip = 5, sheet = 1)

```

### Government Intervention Measurement

Here we create and test a scale of institutionalized preferences for government intervention into the personal lives of individuals. 

Take questions about government's intervention in unlikely events (public security, national security, terrorist act). These questions only exist in issp16

```{r clean_issp, include = F}
# recode all questions so that higher values indicate support for government intervention

issp16 <- issp16 %>%
  mutate(
    cut_spend = car::recode(as.numeric(v7), '8=NA;9=NA'),
    spend_jobs = car::recode(as.numeric(v8), '1=5;2=4;3=3;4=2;5=1;else=NA'),
    reg_biz = car::recode(as.numeric(v9), '8=NA;9=NA'),
    sup_ind = car::recode(as.numeric(v10), '1=5;2=4;3=3;4=2;5=1;else=NA'),
    sup_ind2 = car::recode(as.numeric(v11), '1=5;2=4;3=3;4=2;5=1;else=NA'),
    gov_jobs = car::recode(as.numeric(v21), '1=5;2=4;8=3;3=2;4=1;else=NA'),
    gov_prices = car::recode(as.numeric(v22), '1=5;2=4;8=3;3=2;4=1;else=NA'),
    gov_health = car::recode(as.numeric(v23), '1=5;2=4;8=3;3=2;4=1;else=NA'),
    gov_old = car::recode(as.numeric(v24), '1=5;2=4;8=3;3=2;4=1;else=NA'),
    gov_ind3 = car::recode(as.numeric(v25), '1=5;2=4;8=3;3=2;4=1;else=NA'),
    gov_unemp = car::recode(as.numeric(v26), '1=5;2=4;8=3;3=2;4=1;else=NA'),
    gov_incd = car::recode(as.numeric(v27), '1=5;2=4;8=3;3=2;4=1;else=NA'),
    gov_house = car::recode(as.numeric(v29), '1=5;2=4;8=3;3=2;4=1;else=NA'),
    gov_laws = car::recode(as.numeric(v30), '1=5;2=4;8=3;3=2;4=1;else=NA'),
    gov_surveil = car::recode(as.numeric(v38), '1=5;2=4;8=3;3=2;4=1;else=NA'),
    gov_surveil2 = car::recode(as.numeric(v39), '1=5;2=4;8=3;3=2;4=1;else=NA'),
    gov_open = car::recode(as.numeric(v40), '10=5;9=4.5;8=4;7=3.5;6=3.5;5=3;4=2.5;3=2.5;2=2;1=1.5;0=1;else=NA'),
    gov_secure = car::recode(as.numeric(v41), '1=5;2=4;8=3;3=2;4=1;else=NA'),
    gov_detain = car::recode(as.numeric(v43), '1=5;2=4;8=3;3=2;4=1;else=NA'),
    gov_surveil3 = car::recode(as.numeric(v44), '1=5;2=4;8=3;3=2;4=1;else=NA'),
    gov_surveil4 = car::recode(as.numeric(v45), '1=5;2=4;8=3;3=2;4=1;else=NA'),
    gov_nosay = car::recode(as.numeric(v47), '1=5;2=4;3=3;4=2;5=1;else=NA'),
    cntry = as.numeric(country),
    cow = countrycode(cntry, origin = "iso3n", destination = "cown"),
    wave = 2016
  )%>%
  arrange(cow)


issp16df <- select(issp16, cow, wave, cut_spend:gov_nosay)

issp16_meain <- issp16df[complete.cases(issp16df),]


# check measurement invariance - ISSP 2016




meaInmod1a <- " 
  preference =~ gov_surveil + gov_surveil2 + gov_secure" 
 
meaInmod1b <- " 
  intervene_security =~ 1*gov_surveil + 1.174*gov_surveil2 + 0.933*gov_secure 
  gov_surveil2 ~~ c(a,a,a,b,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a)*gov_secure
"

cfa <- cfa(model = meaInmod1a, data = issp16_meain)
summary(cfa,standardized = TRUE, fit.measures = TRUE)

configural1a <- cfa(model = meaInmod1a, data = issp16_meain, group = "cow")
fitmeasures(configural1a)

metric1a <- cfa(model = meaInmod1a, data = issp16_meain, group = "cow", group.equal = "loadings")
fitmeasures(metric1a)

metric1b <- cfa(model = meaInmod1b, data = issp16_meain, group = "cow")
fitmeasures(metric1b)

# create an authoritarian scale (just the surveillance/personal freedom items). 

issp16_meain$gov_author <- round((issp16_meain$gov_surveil +
                                    1.174*issp16_meain$gov_surveil2 +
                                    0.933*issp16_meain$gov_secure)/3,2)

issp16dfa <- round(aggregate(issp16_meain, by = list(issp16_meain$cow), FUN = mean, na.rm = T),2)

issp16dfa <- dplyr::select(issp16dfa, cow, gov_author)
```

#### Results for Gov. Intervention Measurement

Full multi-group invariance tables are available in the results folder. Below this chunk are fit indices. Naturally a model with only 3 variables has a just-identified baseline and configural invariance model (with the groups freely estimated). Therefore, we rely mostly on the theoretical validity of these measures reflecting an institutionalized type of preference of whether the govenrment has the right in certain circumstances to intervene in private affairs that causes similarites in response patterns across these three items.

```{r issp_tables, echo = F}

T_cfa <- semTable(list("Baseline" = cfa), type = "html", file = "results/T_cfa.html", print.results = F)

T_cfa2 <- semTable(list("Configural" = configural1a), type = "html", file = "results/T_cfa2.html", print.results = F)

T_cfa3 <- semTable(list("Metric" = metric1a), type = "html", file = "results/T_cfa3.html", print.results = F)

T_cfa4 <- semTable(list("Metric" = metric1b), type = "html", file = "results/T_cfa4.html", print.results = F)

# Create table comparing fit statistics

tbl_issp_fit <- matrix(nrow = 7, ncol = 5)

colnames(tbl_issp_fit) <- c("Fit Index","Baseline","Configural","Metric","Metric X")

tbl_issp_fit[1:7,1] <- c("Chi-square", "df","RMSEA","CFI","TLI","AIC","LL")

fitfunc <- function (x) {
  y <- summary(x, fit.measures = T)
  c(round(y[["FIT"]][["chisq"]],3), round(y[["FIT"]][["df"]],3), round(y[["FIT"]][["rmsea"]],3), round(y[["FIT"]][["cfi"]],3), round(y[["FIT"]][["tli"]],3), round(y[["FIT"]][["aic"]],0), round(y[["FIT"]][["logl"]],0))
  }


tbl_issp_fit[1:7,2] <- c(fitfunc(cfa))
tbl_issp_fit[1:7,3] <- c(fitfunc(configural1a))
tbl_issp_fit[1:7,4] <- c(fitfunc(metric1a))
tbl_issp_fit[1:7,5] <- c(fitfunc(metric1b))

tbl_issp_fit <- as.data.frame(tbl_issp_fit)
htmlTable(tbl_issp_fit)
```


### Behaviors Measurment

Here we rescale behaviors from their 0-100 metric, into a standardized scale to make them easy to interpret. There is no missing data because this was already removed by the PIs of the survey prior to making it publicly available. 

####  Clean


```{r clean_betrack, include = F}
betrack <- betrack %>%
  mutate(
    cow = countrycode(iso2c, origin = "iso2c", destination = "cown"),
    stay = scale(beh_stayhome),
    gather = scale(beh_socgathering),
    distance = scale(beh_distance),
    tsymp = scale(beh_tellsymp),
    hwash = scale(beh_handwash)
  ) %>%
  select(cow, date, stay, gather, distance, tsymp, hwash)



```


#### Measurement Invariance - Behaviors

```{r meaInbetrack, echo = F, warning = F}

## Select only those countries in the ISSP
betrack_complete <- betrack[complete.cases(betrack),]
betrack_complete <- betrack_complete[which(betrack_complete$cow %in% issp16df$cow),]
betrack_complete <- betrack_complete[-which(betrack_complete$cow == 115),]



meaInmod2 <- "
  behave =~ stay + gather + distance
"
cfa2 <- cfa(model = meaInmod2, data = betrack_complete)
configural2 <- cfa(model = meaInmod2, data = betrack_complete, group = "cow")

metric2a <- cfa(model = meaInmod2, data = betrack_complete, group = "cow", group.equal = "loadings")

# summary(metric2a, fit.measures = T)

meaInmod2b <- "
    behave =~ 1*stay + 0.776*gather + 1.083*distance
    stay ~~ c(a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,b,a,a,a,a,a,a,a,a)*gather
"

metric2b <- cfa(model = meaInmod2b, data = betrack_complete, group = "cow")

## Create the "behave" variable

betrack_complete$behave <- round((betrack_complete$stay + 0.776*betrack_complete$gather + 1.083*betrack_complete$distance)/3,2)


## Take the Country-Average

betrack_av <- round(aggregate(betrack_complete[,-2], by = list(betrack_complete$cow), FUN = mean, na.rm = T),2)


## Now create a standardized score at the country level

betrack_av <- betrack_av %>% 
  mutate(
    behave = scale(behave)
  ) %>%
  filter(cow %in% issp16dfa$cow) %>%
  select(cow, behave)


```

#### Results for Public Behaviors Measurement
```{r behave_tables, echo = F}

T_cfa <- semTable(list("Baseline" = cfa2), type = "html", file = "results/T_cfa_beh.html", print.results = F)

T_cfa2 <- semTable(list("Configural" = configural2), type = "html", file = "results/T_cfa2_beh.html", print.results = F)

T_cfa3 <- semTable(list("Metric" = metric2a), type = "html", file = "results/T_cfa3_beh.html", print.results = F)

T_cfa4 <- semTable(list("Metric" = metric2b), type = "html", file = "results/T_cfa4_beh.html", print.results = F)

# Create table comparing fit statistics

tbl_issp_fit2 <- matrix(nrow = 7, ncol = 5)

colnames(tbl_issp_fit2) <- c("Fit Index","Baseline","Configural","Metric","Metric X")

tbl_issp_fit2[1:7,1] <- c("Chi-square", "df","RMSEA","CFI","TLI","AIC","LL")


tbl_issp_fit2[1:7,2] <- c(fitfunc(cfa2))
tbl_issp_fit2[1:7,3] <- c(fitfunc(configural2))
tbl_issp_fit2[1:7,4] <- c(fitfunc(metric2a))
tbl_issp_fit2[1:7,5] <- c(fitfunc(metric2b))

tbl_issp_fit2 <- as.data.frame(tbl_issp_fit2)
htmlTable(tbl_issp_fit2)
```
### COVID deaths

```{r clean covid, warning = F, message = F}
covid <- covid %>%
  mutate(
    dpm = total_deaths_per_million, # deaths per million
    cow = countrycode(location, origin = "country.name", destination = "cown"),
  ) %>%
  select(cow, date, dpm) %>%
  filter(cow %in% issp16df$cow)

##  Outbreak Stage (01/03 - 15/03)

dpm_stage1 <- filter(covid, covid$date >= "2020-03-01" & covid$date <= "2020-03-15")

dpm_stage1 <- round(aggregate(dpm_stage1[,-2], by = list(dpm_stage1$cow), FUN = mean, na.rm = TRUE),4)

dpm_stage1$dpm1 <- ifelse(is.nan(dpm_stage1$dpm), 0, dpm_stage1$dpm)

dpm_stage1 <- select(dpm_stage1, cow, dpm1)


## Public Reaction Stage (20/03 - 07/04)

dpm_stage2 <- filter(covid, covid$date >= "2020-03-20" & covid$date <= "2020-04-07")

dpm_stage2 <- round(aggregate(dpm_stage2[,-2], by = list(dpm_stage2$cow), FUN = mean, na.rm = TRUE),4)

dpm_stage2$dpm2 <- ifelse(is.nan(dpm_stage2$dpm), 0, dpm_stage2$dpm)

dpm_stage2 <- select(dpm_stage2, cow, dpm2)



## Sensitivity Analysis - Outbreak Stage: March 1st to March 19th

dpm_stage3 <- filter(covid, covid$date >= "2020-03-01" & covid$date <= "2020-03-19")

dpm_stage3 <- round(aggregate(dpm_stage3[,-2], by = list(dpm_stage3$cow), FUN = mean, na.rm = TRUE),4)

dpm_stage3$dpm3 <- ifelse(is.nan(dpm_stage3$dpm), 0, dpm_stage3$dpm)

dpm_stage3 <- select(dpm_stage3, cow, dpm3)




```

### Blavatnik

```{r clean_blavatnik, warning = F, message = F}

## Outbreak Stage: March 1st to March 15th
gov_resp1 <- gov_resp %>%
  mutate(
    date = as.Date(as.character(Date), "%Y%m%d"),
    chi = ContainmentHealthIndex/20,
    cow = countrycode(CountryName, origin = "country.name", destination = "cown")
  ) %>%
  filter(date >= "2020-03-01" & date <= "2020-03-15" & cow %in% issp16dfa$cow) %>%
  select(CountryName, date, chi)

gov_resp1 <- aggregate(x = gov_resp1[,-2], by = list(gov_resp1$CountryName), FUN = mean)

gov_resp1 <- gov_resp1 %>%
  mutate(
    cname = Group.1,
    cow = countrycode(cname, origin = "country.name", destination = "cown"),
    chi1 = round(scale(chi),2),
    chi1.2 = round(chi,2)
  ) %>% 
  select(cow, chi1, chi1.2) %>%
  arrange(cow)

## Public Reaction Stage: March 20th to April 7th

gov_resp2 <- gov_resp %>%
  mutate(
    date = as.Date(as.character(Date), "%Y%m%d"),
    chi = ContainmentHealthIndex/20,
    cow = countrycode(CountryName, origin = "country.name", destination = "cown")
  ) %>%
  filter(date >= "2020-03-20" & date <= "2020-04-07" & cow %in% issp16dfa$cow) %>%
  select(CountryName, date, chi)

gov_resp2 <- aggregate(x = gov_resp2[,-2], by = list(gov_resp2$CountryName), FUN = mean)

gov_resp2 <- gov_resp2 %>%
  mutate(
    cname = Group.1,
    cow = countrycode(cname, origin = "country.name", destination = "cown"),
    chi2 = round(scale(chi),2),
    chi2.2 = round(chi,2)
  ) %>% 
  select(cow, chi2, chi2.2) %>%
  arrange(cow)

## Sensitivity Analysis - Reaction Stage: March 1st to March 19th

gov_resp3 <- gov_resp %>%
  mutate(
    date = as.Date(as.character(Date), "%Y%m%d"),
    chi = ContainmentHealthIndex/20,
    cow = countrycode(CountryName, origin = "country.name", destination = "cown")
  ) %>%
  filter(date >= "2020-03-01" & date <= "2020-03-19" & cow %in% issp16dfa$cow) %>%
  select(CountryName, date, chi)

gov_resp3 <- aggregate(x = gov_resp3[,-2], by = list(gov_resp3$CountryName), FUN = mean)

gov_resp3 <- gov_resp3 %>%
  mutate(
    cname = Group.1,
    cow = countrycode(cname, origin = "country.name", destination = "cown"),
    chi3 = round(scale(chi),2), 
  ) %>% 
  select(cow, chi3) %>%
  arrange(cow)




```

### Income Inequality 

```{r clean_solt, warning = F, message = F}
rm (swiid)
swiid_summary$cow <- countrycode(swiid_summary$country, "country.name", "cown")

#some countries do not have data since 2016, take most recent available year
swiid_summary <- swiid_summary %>%
  mutate(year = ifelse(country == "Algeria" & year == 2011 | country == "Brunei" & year == 1981 | country == "Bosnia and Herzegovina" & year == 2015 | country == "Grenada" & year == 2008 | country == "Guatemala" & year == 2014 | country == "Iceland" & year == 2015 | country == "India" & year == 2012 | country == "Japan" & year == 2015 | country == "Morocco" & year == 2014 | country == "Pakistan" & year == 2015 | country == "Philippines" & year == 2015 | country == "South Africa" & year == 2015 | country == "United Arab Emirates" & year == 2008 | country == "Venezuela" & year == 2015, 2016, year))

# trim S. Africa
swiid_summary$gini_disp <- ifelse(swiid_summary$country == "South Africa" & swiid_summary$year == 2016, 55, swiid_summary$gini_disp)


swiid_summary <- subset(swiid_summary, year >= 2016)
swiid_summary <- select(swiid_summary, cow, gini_disp)
swiid_summary <- aggregate(swiid_summary, by = list(swiid_summary$cow), FUN = mean, na.rm = T)
gini_disp <- select(swiid_summary, cow, gini_disp)
rm(swiid_summary)


```

### GDP per capita in k$

```{r gdp, warning = F, message = F}

gdp <- gdp %>%
  mutate(
    cow = countrycode(Country.Name, origin = "country.name", destination = "cown"),
    gdp = X2019
  ) %>%
  filter(cow %in% issp16dfa$cow) %>% 
  select(cow, gdp)

## Impute data for Venezuela (IMF report, estimated)

gdp[which(gdp$cow == 101),2] <- 2299.308

## Impute Taiwan (also from IMF report)
gdp[33,1] <- 713 
gdp[33,2] <- 25873.37

# recode GDP to be in k
gdp$gdp <- gdp$gdp/1000

```

### Social Spending

ILO Data

```{r socp, warning = F, message = F}
socp <- socp %>%
  mutate(
    country = ...2,
    soc_spend = round(...19,2)
  ) %>%
  select(country, soc_spend)

socp <- socp[complete.cases(socp$soc_spend),]
socp$cow <- countrycode(socp$country, "country.name","cown")
socp <- socp %>%
  filter(cow %in% issp16dfa$cow) %>%
  select(cow, soc_spend)

```




### Merge data sets

```{r merge_clean}



df <- left_join(issp16dfa, gov_resp1, by = "cow")
df <- left_join(df, gov_resp2, by = "cow")
df <- left_join(df, gov_resp3, by = "cow")
df <- left_join(df, betrack_av, by = "cow")
df <- left_join(df, dpm_stage1, by = "cow")
df <- left_join(df, dpm_stage2, by = "cow")
df <- left_join(df, dpm_stage3, by = "cow")
df <- left_join(df, gini_disp, by = "cow")
df <- left_join(df, gdp, by = "cow")
df <- left_join(df, socp, by = "cow")

## filter out Suriname 
df <- df[-which(df$cow==115),]



```



### Visualizations and Analyses

#### Descriptives

!!!!!! This section needs to be updated

```{r desc}
## Descriptive tables

tab1 <- descr(df[,c("gov_author", "chi1", "chi2", "behave","gini_disp","dpm1","dpm2", 
                    "gdp","soc_spend")],
              show = c("n","mean", "sd","range"))
tab1[,1] <- c("Public Preference", "Government Intervention - First stage", "Government Intervention - Second Stage", "Public Behavior", "Gini", "Deaths per million - First stage", "Deaths per Million - Second Stage", "GDP (k$) per capita", "Social Spending")

colnames(tab1) <- c("Variable", "N",  "Mean", "SD", "Range")

tab1[,c(3:4)] <- round(tab1[,c(3:4)],2)


htmlTable(tab1,rnames = FALSE)

```

#### Measurement Figures

```{r Fig2}
## Figure A2


agg_png(wdir("results/figa2.png"), width = 1600, height = 900)
semPaths(cfa, what = "std", layout = "tree", nodeLabels = c("gov_surv", "gov_surv2","gov_sec", "preference"),sizeLat = 14,sizeMan = 10, edge.color = "black",edge.label.cex = 0.9, nDigits = 3, rotation = 2)
invisible(dev.off())

## Figure A3
agg_png(wdir("results/figa3.png"), width = 1600, height = 900)
semPaths(cfa2, what = "std", layout = "tree", nodeLabels = c("stay", "gather","distance", "behavior"),sizeLat = 14,sizeMan = 10, edge.color = "black",edge.label.cex = 0.9, nDigits = 3, rotation = 2)
invisible(dev.off())

knitr::include_graphics("results/figa2.png")
knitr::include_graphics("results/figa3.png")

```

#### Fig 2

```{r Fig3}
## Figure 3 

chi <- c(df$chi1.2, df$chi2.2)
time <- c(rep("first", 32), rep("second", 32))
cntry <- rep(df$cow, 2)
df2 <- as.data.frame(cbind(chi, time, cntry))
df2$time <- as.factor(df2$time)
df2$chi <- as.numeric(df2$chi)
df2$cntry <- as.factor(df2$cntry)

agg_png(wdir("results/fig2.png"),width = 1600,height = 900)
ggplot(data = df2, aes(x = chi, fill = time)) +
  geom_density(alpha = 0.5, trim = FALSE) + 
  xlab(label = "Government Intervention") +
  ylab(label = "Density") +
  scale_fill_discrete(name = "Period", labels = c("01/03-15/03","20/03 - 07/04")) +
  theme(axis.title = element_text(size = 32,face = "bold"),legend.title = element_text(size = 28, face = "bold"), legend.text = element_text(size = 24)) 
invisible(dev.off())

knitr::include_graphics("results/fig2.png")


```


#### Outbreak Stage

Predict residuals from m11 (requires the least degrees of freedom and theoretical assumptions)

#### Table 2
```{r m1}

m11 <- lm(chi1 ~ dpm1 + gov_author , data = df)

m12 <- lm(chi1 ~ dpm1 + gov_author + gini_disp, data = df)

m13 <- lm(chi1 ~ dpm1 + gov_author + soc_spend, data = df)

m14 <- lm(chi1 ~ dpm1 + gov_author + gdp, data = df)

m15 <- lm(chi1 ~ dpm1 + gov_author + gini_disp + soc_spend + gdp, data = df)

tab_model(m11, m12, m13, m14, m15, p.style = "stars", p.threshold = c(0.10, 0.05, 0.01), show.ci = F,  dv.labels = c("M11", "M12","M13", "M14","M15"), pred.labels = c("Intercept", "Deaths per Million", "Public Preferences", "Disposable Income Inequality", "Social Spending", "GDP (k$, per capita)"))

df$chi1_p <- predict.lm(m11, newdata = df)
df$gap1 <- round(df$chi1 - df$chi1_p,3)
df$gap1_cat <- as.factor(ifelse(df$gap1 > 0, 1, 0))
df$gap1_tri <- as.factor(
  case_when(
    df$gap1 > 0.05 ~ 1,
    df$gap1 < -0.05 ~ -1,
    TRUE ~ 0
  )
)


```


#### Public Reaction Stage

March 20th - April 7th


Now we take the residuals as the discrepancy. We also control for current level of intervention as this influences behaviors.

#### Table 3
```{r m2}


m21 <- lm(behave ~ dpm2 + chi2 , data = df)

m22 <- lm(behave  ~ dpm2 + chi2 + gap1, data = df)

m23 <- lm(behave  ~ dpm2 +  chi2 + gap1  + gini_disp, data = df)

m24 <- lm(behave ~ dpm2 +  chi2 + gap1  + soc_spend, data = df)

m25 <- lm(behave ~ dpm2 + chi2 + gap1 + gdp, data = df)

m26 <- lm(behave ~ dpm2 + chi2 + gap1 + gini_disp + soc_spend + gdp, data = df)



tab_model(m21, m22, m23, m24, m25, m26, p.style = "stars", p.threshold = c(0.10, 0.05, 0.01), show.ci = F,  dv.labels = c("M21", "M22","M23", "M24","M25", "M26"), pred.labels = c("Intercept", "Deaths per Million", "Current Gov. Intervention", "Discrepancy from Outbreak Stage",  "Disposable Income Inequality", "Social Spending", "GDP (k$, per capita)"))
```

#### Table 4
```{r m3}


m31 <- lm(behave ~ dpm2 + chi2 , data = df)

m32 <- lm(behave  ~ dpm2 + chi2 + gap1_cat, data = df)

m33 <- lm(behave  ~ dpm2 +  chi2 + gap1_cat  + gini_disp, data = df)

m34 <- lm(behave ~ dpm2 +  chi2 + gap1_cat  + soc_spend, data = df)

m35 <- lm(behave ~ dpm2 + chi2 + gap1_cat + gdp, data = df)

m36 <- lm(behave ~ dpm2 + chi2 + gap1_cat + gini_disp + soc_spend + gdp, data = df)



tab_model(m31, m32, m33, m34, m35, m36, p.style = "stars", p.threshold = c(0.10, 0.05, 0.01), show.ci = F,  dv.labels = c("M31", "M32","M33", "M34","M35", "M36"), pred.labels = c("Intercept", "Deaths per Million", "Current Gov. Intervention", "Positive Discrepancy from Outbreak Stage",  "Disposable Income Inequality", "Social Spending", "GDP (k$, per capita)"))
```
#### Sensitivity Analysis: 

March 16th - March 31st

Test as a sensitivity analysis

```{r m4}
m4a <- lm(chi3 ~ dpm3 + gov_author, data = df)
df$chi3_p <- predict.lm(m4a, newdata = df)
df$gap2 <- df$chi3 - df$chi3_p

m41 <- lm(behave ~ dpm3 + chi2, data = df)

m42 <- lm(behave ~ dpm3 + gap2 + chi2, data = df)

m43 <- lm(behave ~ dpm3 + gap2 + chi2 + gini_disp , data = df)

m44 <- lm(behave ~ dpm3 + gap2 + chi2 + soc_spend , data = df)

m45 <- lm(behave ~ dpm3 + gap2 + chi2 + gdp, data = df)

m46 <- lm(behave ~ dpm3 + gap2 + chi2 + gini_disp + soc_spend + gdp, data = df)



tab_model(m41, m42, m43, m44, m45, m46, p.style = "stars", p.threshold = c(0.10, 0.05, 0.01), show.ci = F,  dv.labels = c("M41", "M42","M43", "M44","M45", "M46"), pred.labels = c("Intercept", "Deaths per Million", "Current Gov. Intervention", "Discrepancy from Outbreak Phase", "Disposable Income Inequality", "Social Spending", "GDP (k$, per capita)"))
```


#### Alternative Figure - Residuals and Behavior Compared

Our argument rests on counterfactual logic. This means that net of the current government intervention (which has a large impact), how would have people behaved if the intervention in the Outbreak Phase was different.

```{r fig_alt}

# Create partial correlation (predicted behave partialled out from chi2)
partial <- lm(behave ~ chi2, data = df)
df$behave_p <- predict(partial, newdata = df)
df$behave_partial <- df$behave - df$behave_p

# add country ISO 3c
df$iso <- countrycode(df$cow, "cown", "iso3c")

# fix Chile as outlier for better visualization (to the level of SWE)
df$gap1i <- ifelse(df$iso == "CHL", -1.6, df$gap1)

agg_png(filename = "results/Fig_new.png", res = 144, height = 800, width = 1000)
ggplot(df, aes(gap1i, behave_partial, label = iso)) +
  geom_smooth(method = "lm", color = "grey") +  
  geom_text_repel(aes(label = iso)) +
  labs(x = "Less than preferred  < ------                               ------ >  More than preferred\nGovernment Intervention", y = "Public Behaviors\nLess cautious  < ------                     ------ >  More cautious") +
  theme_classic() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())
invisible(dev.off())

knitr::include_graphics("results/Fig_new.png")
```

#### Sample Representativeness

```{r sample}
betrack <- read_dta(wdir("data/GlobalBehaviorsPerceptions_Data_May21_2020.dta")) 


betrack <- betrack %>%
  mutate(
    cow = countrycode(iso2c, origin = "iso2c", destination = "cown"),
    stay = beh_stayhome/20,
    gather = beh_socgathering/20,
    distance = beh_distance/20,
    tsymp = beh_tellsymp/20,
    hwash = beh_handwash/20
  ) %>%
  filter(cow %in% df$cow) %>%
  mutate(
    age_cat = age_yr_bin,
    female = ifelse(gender %in% c(1,2), gender - 1, NA_real_),
    edu_cat = educ_bin,
    edu_yrs = educ,
    inc_cat = inc_bin,
    behave = round((stay + 0.776*gather + 1.083*distance)/3,2)
  )
betrack$cntry <- countrycode(betrack$cow, "cown","country.name")
## Figure A.3
agg_png(wdir("figures/figa3.png"),width = 1600,height = 900)
ggplot(data = betrack, aes(x = age, fill = as.factor(cntry))) +
  geom_density(alpha = 0.5, trim = FALSE) + 
  xlab(label = "Age") +
  ylab(label = "Density") +
  scale_fill_discrete(name = "Country") +
  theme(axis.title = element_text(size = 24,face = "bold"),legend.title = element_text(size = 24, face = "bold"), legend.text = element_text(size = 16)) 
invisible(dev.off())
## Figure A.4
betrack_a4 <- betrack[complete.cases(betrack$edu_cat),]
agg_png(wdir("figures/figa4.png"),width = 1600,height = 900)
ggplot(data = betrack_a4, aes(x = as.factor(edu_cat), fill = as.factor(cntry))) +
  geom_bar() + 
  xlab(label = "Education categories") +
  ylab(label = "Count") +
  coord_flip() +
  scale_fill_discrete(name = "Country") +
  theme(axis.title = element_text(size = 24,face = "bold"),legend.title = element_text(size = 24, face = "bold"), legend.text = element_text(size = 16)) 
invisible(dev.off())

## Figure A.5
betrack_a5 <- betrack[complete.cases(betrack$inc_cat),]
agg_png(wdir("figures/figa5.png"),width = 1600,height = 900)
ggplot(data = betrack_a5, aes(x = as.factor(inc_cat), fill = as.factor(cntry))) +
  geom_bar() + 
  xlab(label = "Income categories") +
  ylab(label = "Count") +
  coord_flip() +
  scale_fill_discrete(name = "Country") +
  theme(axis.title = element_text(size = 24,face = "bold"),legend.title = element_text(size = 24, face = "bold"), legend.text = element_text(size = 16)) 
invisible(dev.off())

## Figure A6
betrack_a6 <- betrack[complete.cases(betrack$female),]

agg_png(wdir("figures/figa6.png"),width = 1600,height = 900)
ggplot(data = betrack_a6, aes(x = as.factor(female), fill = as.factor(cntry))) +
  geom_bar() + 
  xlab(label = "Female") +
  ylab(label = "Count") +
  coord_flip() +
  scale_fill_discrete(name = "Country") +
  theme(axis.title = element_text(size = 24,face = "bold"),legend.title = element_text(size = 24, face = "bold"), legend.text = element_text(size = 16)) 
invisible(dev.off())


```
